<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Management System</title>
    <link rel="stylesheet" href="/static/style.css">
    <!-- SunEditor - Office-like WYSIWYG with full table support -->
    <link href="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/css/suneditor.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/suneditor.min.js"></script>
    <style>
        .sun-editor {
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            background: white;
            margin-bottom: 28px;
        }
        .sun-editor .se-toolbar {
            background-color: #f8f9fa;
            position: sticky !important;
            top: 0;
            z-index: 10;
            border-bottom: 1px solid #e1e8ed;
            padding: 8px;
        }
        .sun-editor .se-wrapper {
            min-height: 450px !important;
            font-family: 'Times New Roman', Times, serif;
            line-height: 1.6;
            letter-spacing: 0.3px;
        }
        .sun-editor .se-wrapper .se-wrapper-inner {
            min-height: 450px !important;
            padding: 20px;
        }
        .sun-editor p {
            margin: 0 0 1.2em 0 !important;
            line-height: 1.6 !important;
        }
        .sun-editor .se-wrapper .se-wrapper-inner p:empty::before {
            content: "\200B";
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="login-section" class="section">
            <div class="card">
                <h1>Document Management System</h1>
                <h2>Login</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Login</button>
                    <div id="login-error" class="error"></div>
                </form>
            </div>
        </div>

        <!-- Main App Section -->
        <div id="app-section" class="section" style="display: none;">
            <nav class="navbar">
                <h1>DMS</h1>
                <div class="nav-right">
                    <div class="user-menu">
                        <button id="user-menu-btn" class="btn-user-menu">
                            <span id="user-display">User</span>
                            <span class="menu-icon">‚ñº</span>
                        </button>
                        <div id="user-dropdown" class="dropdown-menu">
                            <a href="#" onclick="showProfileModal()">Profile & Password</a>
                            <a href="#" onclick="logout()">Logout</a>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="main-content">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab-btn active" data-tab="documents">Documents</button>
                    <button class="tab-btn" data-tab="create">Create Document</button>
                    <button id="templates-tab-btn" class="tab-btn" data-tab="templates" style="display: none;">Templates</button>
                    <button id="users-tab-btn" class="tab-btn" data-tab="users" style="display: none;">Users</button>
                    <button id="audit-tab-btn" class="tab-btn" data-tab="audit" style="display: none;">Audit Logs</button>
                    <button id="backup-tab-btn" class="tab-btn" data-tab="backup" style="display: none;">Backup & Restore</button>
                    <button id="sync-tab-btn" class="tab-btn" data-tab="sync" style="display: none;">Cloud Sync</button>
                </div>

                <!-- Documents Tab -->
                <div id="documents-tab" class="tab-content active">
                    <h2>Documents</h2>
                    
                    <div class="search-bar">
                        <input type="text" id="search-input" placeholder="Search by document number or title...">
                        <button id="search-btn" class="btn btn-primary">Search</button>
                    </div>
                    
                    <!-- Admin filters -->
                    <div id="admin-filters" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3>Filters</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label for="filter-user">Created By User</label>
                                <select id="filter-user">
                                    <option value="">-- All Users --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="filter-date-from">From Date</label>
                                <input type="date" id="filter-date-from">
                            </div>
                            <div class="form-group">
                                <label for="filter-date-to">To Date</label>
                                <input type="date" id="filter-date-to">
                            </div>
                        </div>
                        <button id="apply-filters-btn" class="btn btn-primary">Apply Filters</button>
                        <button id="clear-filters-btn" class="btn">Clear Filters</button>
                    </div>

                    <div id="documents-list" class="documents-list">
                        <!-- Documents will be loaded here -->
                    </div>
                </div>

                <!-- Create Document Tab -->
                <div id="create-tab" class="tab-content">
                    <h2>Create New Document</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1.2fr; gap: 30px; align-items: start;">
                        <!-- Form Section -->
                        <form id="create-document-form" class="card" style="max-width: 100%; margin: 0;">
                            <div class="form-group">
                                <label for="doc-title">Document Title</label>
                                <input type="text" id="doc-title" name="title" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="doc-template">Template</label>
                                <select id="doc-template" name="template_id" required>
                                    <option value="">-- Select a Template --</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="editor-content">Content</label>
                                <textarea id="editor-container" name="content" style="display:none;"></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 14px; font-size: 16px;">Generate Document</button>
                            <div id="create-message" class="message"></div>
                        </form>

                        <!-- Preview Section -->
                        <div class="preview-section">
                            <div class="preview-header">
                                <h3>Live Preview</h3>
                            </div>
                            <div id="preview-content" class="preview-content"></div>
                        </div>
                    </div>
                </div>

                <!-- Templates Tab (Admin Only) -->
                <div id="templates-tab" class="tab-content">
                    <h2>Document Templates</h2>
                    
                    <div class="card" style="margin-bottom: 20px;">
                        <h3>Upload New Template</h3>
                        <form id="upload-template-form">
                            <div class="form-group">
                                <label for="template-name">Template Name</label>
                                <input type="text" id="template-name" name="name" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="template-description">Description</label>
                                <textarea id="template-description" name="description" rows="3"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="template-file">PDF File</label>
                                <input type="file" id="template-file" name="file" accept=".pdf" required>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Upload Template</button>
                            <div id="upload-message" class="message"></div>
                        </form>
                    </div>

                    <h3>Existing Templates</h3>
                    <div id="templates-list" class="templates-list">
                        <!-- Templates will be loaded here -->
                    </div>
                </div>

                <!-- Users Tab (Admin Only) -->
                <div id="users-tab" class="tab-content">
                    <h2>User Management</h2>
                    
                    <div class="card" style="margin-bottom: 20px;">
                        <h3>Create New User</h3>
                        <form id="create-user-form">
                            <div class="form-group">
                                <label for="new-username">Username</label>
                                <input type="text" id="new-username" name="username" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="new-email">Email</label>
                                <input type="email" id="new-email" name="email" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="new-password">Password</label>
                                <input type="password" id="new-password" name="password" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="new-role">Role</label>
                                <select id="new-role" name="role" required>
                                    <option value="user">User</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Create User</button>
                            <div id="create-user-message" class="message"></div>
                        </form>
                    </div>

                    <h3>All Users</h3>
                    <div id="users-list" class="users-list">
                        <!-- Users will be loaded here -->
                    </div>
                </div>

                <!-- Backup & Restore Tab (Admin Only) -->
                <div id="backup-tab" class="tab-content">
                    <h2>Backup & Restore</h2>
                    
                    <div class="card">
                        <h3>Quick Actions</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <button class="btn btn-primary" onclick="backupNow()">üíæ Backup Now</button>
                            <button class="btn btn-secondary" onclick="viewBackups()">üìã View Backups</button>
                            <button class="btn btn-warning" onclick="restoreFromFile()">‚¨ÜÔ∏è Upload & Restore</button>
                        </div>
                        <div id="backup-message" class="message" style="margin-top: 15px;"></div>
                    </div>
                    
                    <div id="backups-list" style="margin-top: 20px;"></div>
                </div>

                <!-- Cloud Sync Tab (Admin Only) -->
                <div id="sync-tab" class="tab-content">
                    <h2>Cloud Sync - SMB/NAS Backup</h2>
                    
                    <div class="card">
                        <h3>SMB/NAS Configuration</h3>
                        <form id="smb-config-form">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label for="smb-host">SMB Host</label>
                                    <input type="text" id="smb-host" placeholder="192.168.1.100 or nas.example.com" required>
                                </div>
                                <div class="form-group">
                                    <label for="smb-port">Port</label>
                                    <input type="number" id="smb-port" value="445" required>
                                </div>
                                <div class="form-group">
                                    <label for="smb-username">Username</label>
                                    <input type="text" id="smb-username" required>
                                </div>
                                <div class="form-group">
                                    <label for="smb-password">Password</label>
                                    <input type="password" id="smb-password" required>
                                </div>
                                <div class="form-group">
                                    <label for="smb-share">Share Name</label>
                                    <input type="text" id="smb-share" placeholder="e.g., Backup, Documents" required>
                                </div>
                                <div class="form-group">
                                    <label for="smb-path">Path in Share</label>
                                    <input type="text" id="smb-path" value="/DMS" required>
                                </div>
                            </div>
                            <div style="margin-top: 15px;">
                                <button type="button" class="btn btn-secondary" onclick="testSMBConnection()">üîó Test Connection</button>
                                <div id="smb-test-result" class="message" style="margin-top: 10px;"></div>
                            </div>
                        </form>
                    </div>

                    <div class="card" style="margin-top: 20px;">
                        <h3>Sync to SMB/NAS</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div>
                                <label>
                                    <input type="radio" name="sync-type" value="documents"> Documents
                                </label>
                            </div>
                            <div>
                                <label>
                                    <input type="radio" name="sync-type" value="logs"> Logs
                                </label>
                            </div>
                            <div>
                                <label>
                                    <input type="radio" name="sync-type" value="all" checked> All (Documents + Logs)
                                </label>
                            </div>
                        </div>
                        <button class="btn btn-primary" style="margin-top: 15px;" onclick="syncToSMB()">‚òÅÔ∏è Sync Now</button>
                        <div id="sync-message" class="message" style="margin-top: 15px;"></div>
                    </div>

                    <div class="card" style="margin-top: 20px;">
                        <h3>Nextcloud / WebDAV Sync</h3>
                        <form id="nextcloud-config-form">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label for="nextcloud-url">Nextcloud URL</label>
                                    <input type="url" id="nextcloud-url" placeholder="https://cloud.example.com" required>
                                </div>
                                <div class="form-group">
                                    <label for="nextcloud-path">Path in Nextcloud</label>
                                    <input type="text" id="nextcloud-path" value="/DMS" required>
                                </div>
                                <div class="form-group">
                                    <label for="nextcloud-username">Username</label>
                                    <input type="text" id="nextcloud-username" required>
                                </div>
                                <div class="form-group">
                                    <label for="nextcloud-password">App Password</label>
                                    <input type="password" id="nextcloud-password" required>
                                </div>
                            </div>
                            <div style="margin-top: 15px;">
                                <button type="button" class="btn btn-secondary" onclick="testNextcloudConnection()">üîó Test Connection</button>
                                <div id="nextcloud-test-result" class="message" style="margin-top: 10px;"></div>
                            </div>
                        </form>
                        
                        <div style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 20px;">
                            <h4>Sync to Nextcloud</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 10px;">
                                <div>
                                    <label>
                                        <input type="radio" name="nextcloud-sync-type" value="documents"> Documents
                                    </label>
                                </div>
                                <div>
                                    <label>
                                        <input type="radio" name="nextcloud-sync-type" value="logs"> Logs
                                    </label>
                                </div>
                                <div>
                                    <label>
                                        <input type="radio" name="nextcloud-sync-type" value="all" checked> All
                                    </label>
                                </div>
                            </div>
                            <button class="btn btn-primary" style="margin-top: 15px;" onclick="syncToNextcloud()">‚òÅÔ∏è Sync to Nextcloud</button>
                            <div id="nextcloud-sync-message" class="message" style="margin-top: 15px;"></div>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 20px;">
                        <h3>Local Directory Sync</h3>
                        <div class="form-group">
                            <label for="local-sync-path">Target Directory Path</label>
                            <input type="text" id="local-sync-path" placeholder="/mnt/backup or /home/user/backup" required>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 10px;">
                            <div>
                                <label>
                                    <input type="radio" name="local-sync-type" value="documents"> Documents
                                </label>
                            </div>
                            <div>
                                <label>
                                    <input type="radio" name="local-sync-type" value="logs"> Logs
                                </label>
                            </div>
                            <div>
                                <label>
                                    <input type="radio" name="local-sync-type" value="all" checked> All
                                </label>
                            </div>
                        </div>
                        <button class="btn btn-primary" style="margin-top: 15px;" onclick="syncToLocal()">üíæ Sync to Local</button>
                        <div id="local-sync-message" class="message" style="margin-top: 15px;"></div>
                    </div>
                </div>

                <!-- Audit Logs Tab -->
                <div id="audit-tab" class="tab-content">
                    <h2>Audit Logs</h2>
                    <div id="audit-logs-list" class="audit-logs">
                        <!-- Audit logs will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Preview Modal -->
    <div id="document-preview-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>Document Preview</h2>
                <button class="modal-close" onclick="closeDocumentPreview()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="preview-doc-info" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div><strong>Document Number:</strong> <span id="preview-doc-number"></span></div>
                        <div><strong>Title:</strong> <span id="preview-doc-title"></span></div>
                        <div><strong>Created By:</strong> <span id="preview-doc-creator"></span></div>
                        <div><strong>Created:</strong> <span id="preview-doc-date"></span></div>
                    </div>
                </div>
                    <div class="preview-section" style="margin-top: 0;">
                        <div class="preview-header">
                            <h3>Content</h3>
                        </div>
                        <iframe id="document-preview-frame" class="preview-pdf-frame" title="Document Preview"></iframe>
                    </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Profile & Password</h2>
                <button class="modal-close" onclick="closeProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="profile-section">
                    <h3>Current Profile</h3>
                    <div class="profile-info">
                        <p><strong>Username:</strong> <span id="profile-username"></span></p>
                        <p><strong>Email:</strong> <span id="profile-email"></span></p>
                        <p><strong>Role:</strong> <span id="profile-role"></span></p>
                    </div>
                </div>

                <div class="profile-section">
                    <h3>Change Password</h3>
                    <form id="change-password-form">
                        <div class="form-group">
                            <label for="current-password">Current Password</label>
                            <input type="password" id="current-password" name="current_password" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="new-password-field">New Password</label>
                            <input type="password" id="new-password-field" name="new_password" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirm-password">Confirm New Password</label>
                            <input type="password" id="confirm-password" name="confirm_password" required>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Change Password</button>
                        <div id="password-message" class="message"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/app.js"></script>
</body>
</html>
